# Настройка интеграции с ЮКасса

Эта инструкция поможет вам настроить интеграцию с ЮКасса для приема платежей.

## 1. Получение ключей от ЮКасса

1. Зарегистрируйтесь в [личном кабинете ЮКасса](https://yookassa.ru/)
2. Создайте магазин и получите `shopId` и `secretKey` в разделе "Настройки" → "API-ключи"
3. Для тестирования используйте тестовые ключи

## 2. Настройка переменных окружения

Добавьте следующие переменные в ваш `.env` файл:

```env
# ЮКасса настройки
YOOKASSA_SHOP_ID=your_shop_id_here
YOOKASSA_SECRET_KEY=your_secret_key_here
YOOKASSA_IS_TEST=true
YOOKASSA_WEBHOOK_SECRET=your_webhook_secret_here
```

### Описание переменных:

- `YOOKASSA_SHOP_ID` - ID вашего магазина в ЮКасса
- `YOOKASSA_SECRET_KEY` - Секретный ключ для API
- `YOOKASSA_IS_TEST` - Режим работы (true для тестового режима)
- `YOOKASSA_WEBHOOK_SECRET` - Секрет для проверки подписи webhook (опционально)

## 3. Настройка webhook в ЮКасса

1. В личном кабинете ЮКасса перейдите в раздел "Настройки" → "Уведомления"
2. Добавьте URL для webhook: `https://yourdomain.com/payment/yookassa/webhook`
3. Выберите события для уведомлений:
   - `payment.succeeded` - успешная оплата
   - `payment.waiting_for_capture` - платеж ожидает подтверждения

## 4. Тестирование интеграции

Для тестирования интеграции:

1. Убедитесь, что `YOOKASSA_IS_TEST=true`
2. Перейдите на страницу `/payment/test`
3. Создайте тестовый заказ
4. Проведите тестовый платеж

### Тестовые карты:

- **Успешная оплата**: `5555555555554444`
- **Отклоненная оплата**: `5555555555554477`
- **3-D Secure**: `5555555555554402`

CVC: любой 3-значный код
Срок действия: любая дата в будущем

## 5. Использование в коде

### Создание платежа:

```php
// В контроллере
public function createPayment(Request $request, int $orderId)
{
    $paymentResult = $this->yookassaPaymentService->createPayment($order);
    
    if ($paymentResult['success']) {
        return redirect($paymentResult['confirmation_url']);
    }
}
```

### Обработка возврата с оплаты:

Настроен автоматический роут: `/payment/complete/{orderId}`

### Обработка webhook:

Настроен автоматический роут: `/payment/yookassa/webhook`

## 6. Особенности интеграции

### Smart Payment сценарий:
- Платеж создается через API ЮКасса
- Пользователь перенаправляется на страницу оплаты ЮКасса
- После оплаты происходит возврат на ваш сайт
- Webhook уведомления обрабатываются автоматически

### Поддерживаемые методы оплаты:
- Банковские карты
- СБП (Система быстрых платежей)
- ЮMoney кошелек
- Apple Pay / Google Pay (на странице ЮКасса)

### Безопасность:
- Все данные карт обрабатываются на стороне ЮКасса
- Ваш сайт не получает и не хранит данные карт
- Webhook подписи проверяются автоматически

## 7. Переход в production

Для работы в production режиме:

1. Получите production ключи в ЮКасса
2. Установите `YOOKASSA_IS_TEST=false`
3. Обновите webhook URL на production домене
4. Проведите тестовые транзакции

## 8. Логирование и отладка

Все события платежей логируются в Laravel logs:

- Создание платежей
- Обработка webhook
- Ошибки интеграции

Для отладки проверьте файлы в `storage/logs/`

## 9. Поддерживаемые статусы платежей

- `pending` - платеж создан, ожидает оплаты
- `waiting_for_capture` - платеж авторизован, ожидает подтверждения
- `succeeded` - платеж успешно проведен
- `canceled` - платеж отменен

## 10. Troubleshooting

### Проблема: Платежи не создаются
- Проверьте правильность `YOOKASSA_SHOP_ID` и `YOOKASSA_SECRET_KEY`
- Убедитесь, что пакет `yoomoney/yookassa-sdk-php` установлен

### Проблема: Webhook не обрабатываются
- Проверьте URL webhook в настройках ЮКасса
- Убедитесь, что URL доступен извне (для production)
- Проверьте логи на ошибки

### Проблема: Тестовые платежи не проходят
- Убедитесь, что `YOOKASSA_IS_TEST=true`
- Используйте тестовые карты из документации ЮКасса
- Проверьте, что тестовый режим включен в личном кабинете 