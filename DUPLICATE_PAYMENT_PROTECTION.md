# Защита от дублирования платежей

## Проблема

При обработке платежей через ЮКассу возникала проблема двойного начисления средств:
1. Пользователь возвращается по ссылке из платежной системы → начисляются средства
2. Приходит webhook от ЮКассы → средства начисляются повторно

## Решение

Реализована многоуровневая защита от дублирования платежей:

### 1. Проверка статуса локального платежа

В методе `handleSuccessfulPayment` добавлена проверка:
- Если платеж уже имеет статус `completed`, обработка пропускается
- Если заказ уже имеет статус `PAID`, баланс не начисляется повторно

### 2. Задержка при обработке возврата

В `PaymentController::handlePaymentComplete` добавлена задержка 3 секунды:
- Позволяет webhook обработаться первым
- Снижает вероятность одновременной обработки

### 3. Дополнительные проверки

- Проверка статуса заказа перед принудительной обработкой
- Обновление данных заказа из БД (`refresh()`) перед проверками
- Подробное логирование всех операций

## Структура защиты

```php
// 1. Проверка статуса платежа
if ($localPayment->status === 'completed') {
    // Платеж уже обработан
    return true;
}

// 2. Проверка статуса заказа
if ($order->status === OrderStatus::PAID) {
    // Заказ уже оплачен, не начисляем баланс
    return true;
}

// 3. Обработка платежа
// Только если все проверки пройдены
```

## Тестирование

Создана команда для тестирования защиты:

```bash
php artisan test:duplicate-payment-protection {orderId}
```

Команда:
1. Получает текущий баланс пользователя
2. Выполняет первую обработку платежа
3. Пытается обработать тот же платеж повторно
4. Проверяет, что баланс не изменился при повторной обработке

## Логирование

Все операции с платежами подробно логируются:
- Попытки повторной обработки
- Статусы заказов и платежей
- Результаты проверок

## Файлы изменений

- `app/Services/Orders/YookassaPaymentService.php` - основная логика защиты
- `app/Http/Controllers/PaymentController.php` - задержка и проверки
- `app/Console/Commands/TestDuplicatePaymentProtection.php` - тестирование

## Принцип работы

1. **Webhook приходит первым** → обрабатывается успешно
2. **Пользователь возвращается** → задержка 3 сек → проверка показывает, что заказ уже оплачен → дублирование предотвращено

ИЛИ

1. **Пользователь возвращается первым** → обрабатывается успешно
2. **Webhook приходит** → проверка показывает, что платеж уже обработан → дублирование предотвращено 