# Улучшенная обработка переходов на новую строку в Word документах

## Проблема

Ранее в системе генерации Word документов была проблема с обработкой переходов на новую строку. Обработчик нежелательных элементов удалял или некорректно обрабатывал переходы на новую строку (`\n`), что приводило к потере форматирования текста.

## Решение

Были внесены следующие улучшения:

### 1. Улучшенный метод `splitTextIntoParagraphs`

Теперь метод правильно обрабатывает:
- **Двойные переходы на новую строку** (`\n\n`) - как границы абзацев
- **Одиночные переходы на новую строку** (`\n`) - как принудительные переходы на новую строку
- **Длинные абзацы** - автоматически разбиваются по предложениям для лучшей читаемости

### 2. Поддержка специальных маркеров форматирования

Добавлена поддержка различных маркеров перехода на новую строку:

#### Маркеры перехода на новую строку:
- `\\n` - экранированный перевод строки
- `<br>`, `<br/>`, `<br />` - HTML теги
- `\r\n` - Windows перевод строки
- `\r` - Mac перевод строки
- `[новая строка]` - текстовый маркер на русском
- `[перевод строки]` - текстовый маркер на русском
- `[break]` - английский маркер

#### Маркеры нового абзаца:
- `\\n\\n` - двойной экранированный перевод строки
- `<p>`, `</p>` - HTML теги параграфов
- `[новый абзац]` - текстовый маркер на русском
- `[абзац]` - текстовый маркер на русском
- `[paragraph]` - английский маркер

### 3. Улучшенная очистка XML

Метод `sanitizeForXml` теперь:
- Сохраняет переходы на новую строку
- Нормализует множественные переводы строк
- Убирает лишние пробелы между переносами
- Не удаляет более двух переносов подряд

### 4. Поддержка в упрощенном документе

Создан отдельный метод `splitTextIntoParagraphsSimple` для обработки переходов на новую строку в упрощенных документах (fallback режим).

## Примеры использования

### Исходный текст с переходами на новую строку:
```
Это первый абзац.
Это вторая строка того же абзаца.

Это новый абзац.
И еще одна строка.

Третий абзац здесь.
```

### Результат обработки:
- **Абзац 1**: "Это первый абзац."
- **Абзац 2**: "Это вторая строка того же абзаца."
- **Абзац 3**: "Это новый абзац."
- **Абзац 4**: "И еще одна строка."
- **Абзац 5**: "Третий абзац здесь."

### Текст со специальными маркерами:
```
Первая строка[новая строка]Вторая строка[новый абзац]Новый абзац
```

### Результат обработки:
- **Абзац 1**: "Первая строка"
- **Абзац 2**: "Вторая строка"
- **Абзац 3**: "Новый абзац"

## Технические детали

### Измененные методы:
1. `splitTextIntoParagraphs()` - основной метод разделения текста
2. `splitTextIntoParagraphsSimple()` - упрощенный метод для fallback
3. `processFormattingMarkers()` - новый метод обработки маркеров
4. `sanitizeForXml()` - улучшенная очистка XML

### Порядок обработки:
1. Обработка специальных маркеров форматирования
2. Очистка от проблемных XML символов
3. Разделение по двойным переносам строк (абзацы)
4. Обработка одиночных переносов строк внутри абзацев
5. Разделение длинных абзацев по предложениям
6. Фильтрация пустых абзацев

## Совместимость

Изменения полностью обратно совместимы. Старые документы будут обрабатываться как прежде, но новые получат улучшенную обработку переходов на новую строку.

## Логирование

Все операции обработки текста логируются для отладки. Проверить работу можно через:

```bash
tail -f storage/logs/laravel.log | grep "Word документ"
``` 