#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
# –ê–≤—Ç–æ—Ä: –°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è OpenAI API
# –î–∞—Ç–∞: $(date)

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check_dependencies() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    
    if ! command -v php &> /dev/null; then
        error "PHP –Ω–µ –Ω–∞–π–¥–µ–Ω"
        exit 1
    fi
    
    if [ ! -f "artisan" ]; then
        error "–§–∞–π–ª artisan –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Laravel"
        exit 1
    fi
    
    success "–í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞–π–¥–µ–Ω—ã"
}

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
setup_results_directory() {
    local results_dir="multi_document_test_results"
    
    if [ ! -d "$results_dir" ]; then
        mkdir -p "$results_dir"
        log "–°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: $results_dir"
    fi
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–∞–Ω—Å–∞
    export TEST_SESSION_DIR="$results_dir/session_$(date +'%Y%m%d_%H%M%S')"
    mkdir -p "$TEST_SESSION_DIR"
    log "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–µ–∞–Ω—Å–∞: $TEST_SESSION_DIR"
}

# –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
scenario_basic() {
    log "üß™ –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏"
    log "   - 5 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"
    log "   - 3 –≤–æ—Ä–∫–µ—Ä–∞"
    log "   - 3 –∏—Ç–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –≤–æ—Ä–∫–µ—Ä–∞"
    log "   - –ó–∞–¥–µ—Ä–∂–∫–∞ 2 —Å–µ–∫—É–Ω–¥—ã"
    
    php artisan debug:multi-doc-parallel \
        --documents=5 \
        --workers=3 \
        --iterations=3 \
        --delay=2 \
        --create-new 2>&1 | tee "$TEST_SESSION_DIR/scenario_basic.log"
    
    if [ $? -eq 0 ]; then
        success "–ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ"
    else
        error "–ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–æ–π"
        return 1
    fi
}

# –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
scenario_intensive() {
    log "üî• –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
    log "   - 8 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"
    log "   - 5 –≤–æ—Ä–∫–µ—Ä–æ–≤"
    log "   - 5 –∏—Ç–µ—Ä–∞—Ü–∏–π –Ω–∞ –≤–æ—Ä–∫–µ—Ä–∞"
    log "   - –ó–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞"
    
    php artisan debug:multi-doc-parallel \
        --documents=8 \
        --workers=5 \
        --iterations=5 \
        --delay=1 \
        --create-new 2>&1 | tee "$TEST_SESSION_DIR/scenario_intensive.log"
    
    if [ $? -eq 0 ]; then
        success "–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ"
    else
        error "–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–æ–π"
        return 1
    fi
}

# –°—Ü–µ–Ω–∞—Ä–∏–π 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
scenario_many_documents() {
    log "üìö –°—Ü–µ–Ω–∞—Ä–∏–π 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"
    log "   - 15 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"
    log "   - 4 –≤–æ—Ä–∫–µ—Ä–∞"
    log "   - 2 –∏—Ç–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –≤–æ—Ä–∫–µ—Ä–∞"
    log "   - –ó–∞–¥–µ—Ä–∂–∫–∞ 3 —Å–µ–∫—É–Ω–¥—ã"
    
    php artisan debug:multi-doc-parallel \
        --documents=15 \
        --workers=4 \
        --iterations=2 \
        --delay=3 \
        --create-new 2>&1 | tee "$TEST_SESSION_DIR/scenario_many_docs.log"
    
    if [ $? -eq 0 ]; then
        success "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ"
    else
        error "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–æ–π"
        return 1
    fi
}

# –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫
scenario_fast() {
    log "‚ö° –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫"
    log "   - 6 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"
    log "   - 6 –≤–æ—Ä–∫–µ—Ä–æ–≤"
    log "   - 3 –∏—Ç–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –≤–æ—Ä–∫–µ—Ä–∞"
    log "   - –ë–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫"
    
    php artisan debug:multi-doc-parallel \
        --documents=6 \
        --workers=6 \
        --iterations=3 \
        --delay=0 \
        --create-new 2>&1 | tee "$TEST_SESSION_DIR/scenario_fast.log"
    
    if [ $? -eq 0 ]; then
        success "–ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ"
    else
        error "–ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–æ–π"
        return 1
    fi
}

# –°—Ü–µ–Ω–∞—Ä–∏–π 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
scenario_existing_docs() {
    log "üîÑ –°—Ü–µ–Ω–∞—Ä–∏–π 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏"
    log "   - 10 —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"
    log "   - 3 –≤–æ—Ä–∫–µ—Ä–∞"
    log "   - 4 –∏—Ç–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –≤–æ—Ä–∫–µ—Ä–∞"
    log "   - –ó–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞"
    
    php artisan debug:multi-doc-parallel \
        --documents=10 \
        --workers=3 \
        --iterations=4 \
        --delay=1 2>&1 | tee "$TEST_SESSION_DIR/scenario_existing.log"
    
    if [ $? -eq 0 ]; then
        success "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ"
    else
        error "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–æ–π"
        return 1
    fi
}

# –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
analyze_all_results() {
    log "üìà –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤..."
    
    local analysis_file="$TEST_SESSION_DIR/combined_analysis.md"
    
    cat > "$analysis_file" << EOF
# –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ–∞–Ω—Å–µ
- **–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:** $(date)
- **–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:** $TEST_SESSION_DIR
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:** 5

## –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –î–æ–∫—É–º–µ–Ω—Ç—ã: 5
- –í–æ—Ä–∫–µ—Ä—ã: 3
- –ò—Ç–µ—Ä–∞—Ü–∏–∏: 3
- –ó–∞–¥–µ—Ä–∂–∫–∞: 2—Å

### 2. –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –î–æ–∫—É–º–µ–Ω—Ç—ã: 8
- –í–æ—Ä–∫–µ—Ä—ã: 5
- –ò—Ç–µ—Ä–∞—Ü–∏–∏: 5
- –ó–∞–¥–µ—Ä–∂–∫–∞: 1—Å

### 3. –ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –î–æ–∫—É–º–µ–Ω—Ç—ã: 15
- –í–æ—Ä–∫–µ—Ä—ã: 4
- –ò—Ç–µ—Ä–∞—Ü–∏–∏: 2
- –ó–∞–¥–µ—Ä–∂–∫–∞: 3—Å

### 4. –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –î–æ–∫—É–º–µ–Ω—Ç—ã: 6
- –í–æ—Ä–∫–µ—Ä—ã: 6
- –ò—Ç–µ—Ä–∞—Ü–∏–∏: 3
- –ó–∞–¥–µ—Ä–∂–∫–∞: 0—Å

### 5. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
- –î–æ–∫—É–º–µ–Ω—Ç—ã: 10
- –í–æ—Ä–∫–µ—Ä—ã: 3
- –ò—Ç–µ—Ä–∞—Ü–∏–∏: 4
- –ó–∞–¥–µ—Ä–∂–∫–∞: 1—Å

## –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤

EOF

    # –ê–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
    for scenario in basic intensive many_docs fast existing; do
        local log_file="$TEST_SESSION_DIR/scenario_${scenario}.log"
        
        if [ -f "$log_file" ]; then
            echo "### –°—Ü–µ–Ω–∞—Ä–∏–π: $scenario" >> "$analysis_file"
            echo "" >> "$analysis_file"
            
            # –ü–æ–¥—Å—á–µ—Ç —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
            local success_count=$(grep -c "—É—Å–ø–µ—à–Ω–æ\|successfully\|completed" "$log_file" || echo "0")
            local error_count=$(grep -c "–æ—à–∏–±–∫–∞\|error\|failed" "$log_file" || echo "0")
            local active_run_errors=$(grep -c "active run" "$log_file" || echo "0")
            
            echo "- **–£—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:** $success_count" >> "$analysis_file"
            echo "- **–û—à–∏–±–æ–∫:** $error_count" >> "$analysis_file"
            echo "- **–û—à–∏–±–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö run:** $active_run_errors" >> "$analysis_file"
            echo "" >> "$analysis_file"
        else
            echo "### –°—Ü–µ–Ω–∞—Ä–∏–π: $scenario - –ü–†–û–ü–£–©–ï–ù" >> "$analysis_file"
            echo "" >> "$analysis_file"
        fi
    done
    
    # –û–±—â–∏–µ –≤—ã–≤–æ–¥—ã
    cat >> "$analysis_file" << EOF

## –û–±—â–∏–µ –≤—ã–≤–æ–¥—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –õ—É—á—à–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—é —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∫ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
- –•—É–¥—à–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ—à–∏–±–æ–∫

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. **–ï—Å–ª–∏ –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö run:** –£–ª—É—á—à–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –º–µ–∂–¥—É –≤–æ—Ä–∫–µ—Ä–∞–º–∏
2. **–ï—Å–ª–∏ –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
3. **–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é:** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–µ–∫ –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
1. –ê–Ω–∞–ª–∏–∑ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤ –≤ storage/logs/
2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
3. –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
EOF

    success "–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: $analysis_file"
}

# –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
generate_report() {
    log "üìä –°–æ–∑–¥–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞..."
    
    local report_file="$TEST_SESSION_DIR/final_report.html"
    
    cat > "$report_file" << EOF
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç—á–µ—Ç –æ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background: #f4f4f4; padding: 20px; border-radius: 5px; }
        .scenario { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß™ –û—Ç—á–µ—Ç –æ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏</h1>
        <p><strong>–î–∞—Ç–∞:</strong> $(date)</p>
        <p><strong>–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:</strong> $TEST_SESSION_DIR</p>
    </div>
    
    <h2>üìã –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
    
    <div class="scenario">
        <h3>1. –ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Å —É–º–µ—Ä–µ–Ω–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π</p>
        <table>
            <tr><th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr>
            <tr><td>–î–æ–∫—É–º–µ–Ω—Ç—ã</td><td>5</td></tr>
            <tr><td>–í–æ—Ä–∫–µ—Ä—ã</td><td>3</td></tr>
            <tr><td>–ò—Ç–µ—Ä–∞—Ü–∏–∏</td><td>3</td></tr>
            <tr><td>–ó–∞–¥–µ—Ä–∂–∫–∞</td><td>2—Å</td></tr>
        </table>
    </div>
    
    <div class="scenario">
        <h3>2. –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π</p>
        <table>
            <tr><th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr>
            <tr><td>–î–æ–∫—É–º–µ–Ω—Ç—ã</td><td>8</td></tr>
            <tr><td>–í–æ—Ä–∫–µ—Ä—ã</td><td>5</td></tr>
            <tr><td>–ò—Ç–µ—Ä–∞—Ü–∏–∏</td><td>5</td></tr>
            <tr><td>–ó–∞–¥–µ—Ä–∂–∫–∞</td><td>1—Å</td></tr>
        </table>
    </div>
    
    <div class="scenario">
        <h3>3. –ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h3>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏</p>
        <table>
            <tr><th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr>
            <tr><td>–î–æ–∫—É–º–µ–Ω—Ç—ã</td><td>15</td></tr>
            <tr><td>–í–æ—Ä–∫–µ—Ä—ã</td><td>4</td></tr>
            <tr><td>–ò—Ç–µ—Ä–∞—Ü–∏–∏</td><td>2</td></tr>
            <tr><td>–ó–∞–¥–µ—Ä–∂–∫–∞</td><td>3—Å</td></tr>
        </table>
    </div>
    
    <div class="scenario">
        <h3>4. –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏</p>
        <table>
            <tr><th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr>
            <tr><td>–î–æ–∫—É–º–µ–Ω—Ç—ã</td><td>6</td></tr>
            <tr><td>–í–æ—Ä–∫–µ—Ä—ã</td><td>6</td></tr>
            <tr><td>–ò—Ç–µ—Ä–∞—Ü–∏–∏</td><td>3</td></tr>
            <tr><td>–ó–∞–¥–µ—Ä–∂–∫–∞</td><td>0—Å</td></tr>
        </table>
    </div>
    
    <div class="scenario">
        <h3>5. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h3>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</p>
        <table>
            <tr><th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr>
            <tr><td>–î–æ–∫—É–º–µ–Ω—Ç—ã</td><td>10</td></tr>
            <tr><td>–í–æ—Ä–∫–µ—Ä—ã</td><td>3</td></tr>
            <tr><td>–ò—Ç–µ—Ä–∞—Ü–∏–∏</td><td>4</td></tr>
            <tr><td>–ó–∞–¥–µ—Ä–∂–∫–∞</td><td>1—Å</td></tr>
        </table>
    </div>
    
    <h2>üìÅ –§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2>
    <ul>
        <li><a href="scenario_basic.log">–ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</a></li>
        <li><a href="scenario_intensive.log">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</a></li>
        <li><a href="scenario_many_docs.log">–ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</a></li>
        <li><a href="scenario_fast.log">–ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</a></li>
        <li><a href="scenario_existing.log">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</a></li>
        <li><a href="combined_analysis.md">–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑</a></li>
    </ul>
    
    <h2>üîç –î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</h2>
    <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Laravel –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ <code>storage/logs/</code> –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.</p>
    
    <footer style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd;">
        <p><small>–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏—Å—Ç–µ–º–æ–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è OpenAI API</small></p>
    </footer>
</body>
</html>
EOF

    success "HTML –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: $report_file"
}

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
cleanup_old_results() {
    log "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
    
    # –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
    find multi_document_test_results -type d -name "session_*" -mtime +7 -exec rm -rf {} \; 2>/dev/null || true
    
    success "–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
}

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    log "üöÄ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏"
    log "=================================================="
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    check_dependencies
    
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    setup_results_directory
    cleanup_old_results
    
    # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    local total_scenarios=5
    local passed_scenarios=0
    local failed_scenarios=0
    
    # –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
    log "–ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
    
    # –°—Ü–µ–Ω–∞—Ä–∏–π 1
    if scenario_basic; then
        ((passed_scenarios++))
    else
        ((failed_scenarios++))
    fi
    
    sleep 5  # –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏
    
    # –°—Ü–µ–Ω–∞—Ä–∏–π 2
    if scenario_intensive; then
        ((passed_scenarios++))
    else
        ((failed_scenarios++))
    fi
    
    sleep 5
    
    # –°—Ü–µ–Ω–∞—Ä–∏–π 3
    if scenario_many_documents; then
        ((passed_scenarios++))
    else
        ((failed_scenarios++))
    fi
    
    sleep 5
    
    # –°—Ü–µ–Ω–∞—Ä–∏–π 4
    if scenario_fast; then
        ((passed_scenarios++))
    else
        ((failed_scenarios++))
    fi
    
    sleep 5
    
    # –°—Ü–µ–Ω–∞—Ä–∏–π 5
    if scenario_existing_docs; then
        ((passed_scenarios++))
    else
        ((failed_scenarios++))
    fi
    
    # –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    analyze_all_results
    generate_report
    
    # –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
    log "=================================================="
    log "üìä –ò–¢–û–ì–û–í–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´"
    log "=================================================="
    log "–í—Å–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: $total_scenarios"
    success "–£—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: $passed_scenarios"
    if [ $failed_scenarios -gt 0 ]; then
        error "–ó–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–æ–π: $failed_scenarios"
    fi
    log "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: $TEST_SESSION_DIR"
    
    if [ $failed_scenarios -eq 0 ]; then
        success "üéâ –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
        return 0
    else
        warning "‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–∞–º–∏"
        return 1
    fi
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
case "${1:-all}" in
    "basic")
        check_dependencies
        setup_results_directory
        scenario_basic
        ;;
    "intensive")
        check_dependencies
        setup_results_directory
        scenario_intensive
        ;;
    "many-docs")
        check_dependencies
        setup_results_directory
        scenario_many_documents
        ;;
    "fast")
        check_dependencies
        setup_results_directory
        scenario_fast
        ;;
    "existing")
        check_dependencies
        setup_results_directory
        scenario_existing_docs
        ;;
    "all"|"")
        main
        ;;
    "help"|"-h"|"--help")
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–°–¶–ï–ù–ê–†–ò–ô]"
        echo ""
        echo "–°—Ü–µ–Ω–∞—Ä–∏–∏:"
        echo "  basic      - –ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
        echo "  intensive  - –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
        echo "  many-docs  - –ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"
        echo "  fast       - –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
        echo "  existing   - –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã"
        echo "  all        - –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
        echo "  help       - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
        echo ""
        echo "–ü—Ä–∏–º–µ—Ä—ã:"
        echo "  $0                  # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏"
        echo "  $0 basic           # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
        echo "  $0 intensive       # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
        ;;
    *)
        error "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: $1"
        echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ '$0 help' –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏"
        exit 1
        ;;
esac 